{% extends "layout.html" %}

{% block title %}Listado de Tutorías{% endblock %}

{% block content %}
<div class="container">
    <h1>Listado de Formatos de Tutoría</h1>

    <!-- Barra de búsqueda -->
    <div class="search-container box">
        <input 
            type="text" 
            id="searchInput" 
            placeholder="Buscar por docente, tutoría o fecha..." 
            onkeyup="filterHistorialTutorias()" 
            class="search-box">
    </div>

    <!-- Mostrar mensajes flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div id="flash-messages">
                {% for category, message in messages %}
                    <div class="flash {{ category }}">{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- Tabla de formatos -->
    <table id="historialTutoriasTable">
        <thead>
            <tr>
                <th>#</th>
                <th>Docente</th>
                <th>Estudiante</th>
                <th>Código Tutoría</th>
                <th>Espacio Académico</th>
                <th>Temas Tratados</th>
                <th>Compromisos Adquiridos</th>
                <th>Fecha</th>
            </tr>
        </thead>
        <tbody>
            {% for formato in formatos %}
            <tr>
                <td>{{ loop.index }}</td>
                <td>{{ formato.docente.nombre_completo }}</td>
                <td>{{ formato.estudiante.nombre_completo }}</td>
                <td>{{ formato.tutoria.codigo }}</td>
                <td>{{ formato.espacio_academico }}</td>
                <td>{{ formato.temas_tratados or "N/A" }}</td>
                <td>
                    {% if formato.compromisos_adquiridos %}
                        {{ formato.compromisos_adquiridos | join(', ') }}
                    {% else %}
                        No hay compromisos
                    {% endif %}
                </td>
                <td>{{ formato.fecha_realizacion }}</td>
            </tr>
            {% else %}
            <tr>
                <td colspan="8">No hay formatos de tutoría registrados.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="button">
        <a href="{{ url_for('dashboard') }}">Volver al Dashboard</a>
        <a href="{{ url_for('exportar_csv_estudiante', estudiante_id=estudiante_id) }}" class="btn">Exportar CSV</a>
        <a href="{{ url_for('exportar_pdf_estudiante', estudiante_id=estudiante_id) }}" class="btn">Exportar PDF</a>
    </div>
</div>

<!-- Pie de página -->
<footer class="footer">
    Todos los derechos reservados
</footer>

<!-- Script de búsqueda -->
<script>
    function filterHistorialTutorias() {
        const searchInput = document.getElementById('searchInput').value.toLowerCase();
        const rows = document.querySelectorAll('#historialTutoriasTable tbody tr');

        rows.forEach(row => {
            const docente = row.cells[1].textContent.toLowerCase(); // Columna Docente
            const tutoria = row.cells[4].textContent.toLowerCase(); // Columna Tutoria
            const fecha = row.cells[7].textContent.toLowerCase(); // Columna Fecha

            if (docente.includes(searchInput) || tutoria.includes(searchInput) || fecha.includes(searchInput)) {
                row.style.display = ''; // Mostrar la fila
            } else {
                row.style.display = 'none'; // Ocultar la fila
            }
        });
    }
</script>
{% endblock %}
